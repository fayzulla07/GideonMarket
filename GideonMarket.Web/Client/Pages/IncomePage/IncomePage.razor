@page "/income"

@using Syncfusion.Blazor.Grids
@using GideonMarket.Web.Client.Pages.Components.Product;
@using GideonMarket.Web.Client.Pages.Components.Income;
@using GideonMarket.Web.Client.Pages.Components.Place;

<CreateIncomeCmpt Places="@Places"/>

<SfGrid DataSource="@Data" Toolbar="@(new List<string>() { "Add", "Edit", "Delete", "Cancel", "Update","SaveIncome" })" Height="315">
    @*<GridEvents OnActionComplete="ActionComplete" TValue="IncomeItemViewModel"></GridEvents>*@
    <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" Mode="EditMode.Dialog" ShowDeleteConfirmDialog="true"></GridEditSettings>
    <GridColumns>
        <GridColumn Field=@nameof(IncomeItemViewModel.Id) Visible="false" HeaderText="ID" IsPrimaryKey="true" IsIdentity="true" ValidationRules="@(new ValidationRules{ Required=true})" TextAlign="TextAlign.Right" Width="120"></GridColumn>

        <GridColumn Field=@nameof(IncomeItemViewModel.ProductId) HeaderText="Продукт" ValidationRules="@(new ValidationRules{ Required=true})" Width="120"
                    EditType="EditType.DropDownEdit" ForeignKeyField="Id" ForeignKeyValue="Name" DataSource="@lstProduct"></GridColumn>
        <GridColumn Field=@nameof(IncomeItemViewModel.Count) HeaderText="Количество" ValidationRules="@(new ValidationRules{ Required=true})" Width="120"></GridColumn>
        <GridColumn Field=@nameof(IncomeItemViewModel.Price) HeaderText="Цена" ValidationRules="@(new ValidationRules{ Required=true})" Width="120"></GridColumn>
        <GridColumn Field=@nameof(IncomeItemViewModel.Description) HeaderText="Описание" Width="120"></GridColumn>
    </GridColumns>
</SfGrid>

@code{
    [Inject]
    public HttpClient client { get; set; }
    public List<IncomeItemViewModel> Data;
    public List<ProductViewModel> lstProduct { get; set; }
    public List<PlaceViewModel> Places { get; set; }
    EditModified editType;
    protected async override Task OnInitializedAsync()
    {
        Data = new List<IncomeItemViewModel>();
        lstProduct = await client.GetFromJsonAsync<List<ProductViewModel>>($"/api/product");

        Places = await client.GetFromJsonAsync<List<PlaceViewModel>>($"api/place");
    }
    public void ActionComplete(ActionEventArgs<IncomeItemViewModel> args)
    {
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.BeginEdit)
        {
            editType = EditModified.Updated;
        }
        else if (args.RequestType == Syncfusion.Blazor.Grids.Action.Add)
        {
            editType = EditModified.Added;
        }
        else if (args.RequestType == Syncfusion.Blazor.Grids.Action.Save)
        {
            if (editType == EditModified.Added)
            {
                //Data.Add(args.Data);
            }
            else if (editType == EditModified.Updated)
            {
                var res = Data.FirstOrDefault(p => p.Id == args.Data.Id);
                if (res != null)
                {
                    res.Id = args.Data.Id;
                    res.IncomeId = args.Data.IncomeId;
                    res.Price = args.Data.Price;
                    res.ProductId = args.Data.ProductId;
                    res.Count = args.Data.Count;
                    res.Description = args.Data.Description;
                }
            }
        }
        else if (args.RequestType == Syncfusion.Blazor.Grids.Action.Delete)
        {
            Data.Remove(args.Data);
        }
        //else if(args)
    }

}
